(function(){"use strict";function p(o,h){let f=0;for(let t=0;t<o.length;t+=4){const g=o[t]-h[t];f+=Math.abs(g/255)}return f}function u(o,h,f,t){o.beginPath();let[g,d]=t[h];o.moveTo(g,d),[g,d]=t[f],o.lineTo(g,d),o.stroke()}self.onmessage=async o=>{console.time();const{numNails:h,imageFile:f,radius:t,threadWeight:g,reverseContrast:d}=o.data,I=Array.from({length:h},(n,c)=>{const r=c/h*2*Math.PI;return[t+t*Math.cos(r),t+t*Math.sin(r)]}),y=await createImageBitmap(f),a=new OffscreenCanvas(t*2,t*2);a.width=t*2,a.height=t*2;const e=a.getContext("2d");if(!e){self.postMessage({error:"no context"});return}e.drawImage(y,0,0,a.width,a.height);const s=e.getImageData(0,0,a.width,a.height).data;e.clearRect(0,0,a.width,a.height),e.beginPath(),e.arc(t,t,t,0,2*Math.PI),e.fillStyle=d?"black":"white",e.fill(),e.lineWidth=g*t/512,e.strokeStyle=d?"white":"black";for(let n=0;n<s.length;n+=4){const c=s[n],r=s[n+1],l=s[n+2],m=.2126*c+.7152*r+.0722*l;s[n]=m,s[n+1]=m,s[n+2]=m}const i=[0];let b,w=1/0;do{b=w;const n=e.getImageData(0,0,a.width,a.height);let c=1/0,r=-1;for(let l=0;l<h;l++){if(l===i[i.length-1]||l===i[i.length-2])continue;u(e,i[i.length-1],l,I);const m=p(e.getImageData(0,0,a.width,a.height).data,s);m<c&&(c=m,r=l),e.putImageData(n,0,0)}r!==-1&&(u(e,i[i.length-1],r,I),i.push(r),w=c)}while(w<b);console.log(`error: ${w}
num lines: ${i.length-1}`),self.postMessage({imgData:e.getImageData(0,0,a.width,a.height)}),console.timeEnd(),console.timeLog()}})();
