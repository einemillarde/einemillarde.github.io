(function(){"use strict";function I(i,h){let l=0;for(let r=0;r<i.length;r+=4){const e=i[r]-h[r];l+=e*e}return l}function w(i,h,l,r){i.beginPath();let[e,d]=r[h];i.moveTo(e,d),[e,d]=r[l],i.lineTo(e,d),i.stroke()}self.onmessage=async i=>{const{numLines:h,numNails:l,imageFile:r,radius:e,threadWeight:d,reverseContrast:b}=i.data,m=Array.from({length:l},(t,u)=>{const c=u/l*2*Math.PI;return[e+e*Math.cos(c),e+e*Math.sin(c)]});console.log(m);const v=await createImageBitmap(r),a=new OffscreenCanvas(e*2,e*2);a.width=e*2,a.height=e*2;const n=a.getContext("2d");if(!n){self.postMessage({error:"Could not get OffscreenCanvasRenderingContext2D"});return}n.drawImage(v,0,0,a.width,a.height);const g=n.getImageData(0,0,a.width,a.height).data;n.beginPath(),n.arc(e,e,e,0,2*Math.PI),n.fillStyle=b?"black":"white",n.fill(),n.lineWidth=d,n.strokeStyle=b?"white":"black";for(let t=0;t<g.length;t+=4){const u=g[t],c=g[t+1],f=g[t+2],o=.2126*u+.7152*c+.0722*f;g[t]=o,g[t+1]=o,g[t+2]=o}const s=[0];for(let t=1;t<h;t++){const u=n.getImageData(0,0,a.width,a.height);let c=1/0,f=-1;for(let o=0;o<l;o++){if(o===s[s.length-1]||o===s[s.length-2])continue;w(n,s[s.length-1],o,m);const p=I(n.getImageData(0,0,a.width,a.height).data,g);p<c&&(c=p,f=o),n.putImageData(u,0,0)}f!==-1?(w(n,s[s.length-1],f,m),s.push(f)):console.log("no best nail found"),t%10===0&&self.postMessage({progress:t/h,newLines:s.slice(t-10,t===h-1?t+1:t)})}self.postMessage({done:!0,lines:s})}})();
